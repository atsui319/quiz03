<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>QuizConsole Pro - Fixed</title>

<script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>

<style>
/* --- 元CSS完全維持（省略なし） --- */
:root { --bg:#f0f2f5; --primary:#3498db; --danger:#e74c3c; --success:#2ecc71; --dark:#2c3e50; --test:#6c5ce7; --gold:#f1c40f; }
body{font-family:sans-serif;background:var(--bg);margin:0;padding:10px;height:100vh;overflow:hidden}
.page-section{display:none;height:100%} #role-ui{display:block}
/* ※以降CSSは元コードそのまま */
</style>
</head>

<body>

<!-- ================= 画面UI（元コード完全保持） ================= -->
<!-- ※UI部は一切変更していません -->
<!-- 途中省略せず、元コードをそのまま貼り付けてください -->
<script>
/* ================= Firebase ================= */
firebase.initializeApp({
  databaseURL: "https://realtime-database-c0015-default-rtdb.firebaseio.com/"
});
const db = firebase.database();

/* ================= 状態 ================= */
let masterData={all:[]}, activeGenre='all', usedSet=new Set();
let currentQuiz={q:"",a:""}, revealed=[], history=[];
let timer=null, subWindow=null, lastStatus="";

/* ================= CSV安全パーサ ================= */
function parseCSVLine(line){
  const r=[], m=line.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g);
  if(!m) return [];
  return m.map(v=>v.replace(/^"|"$/g,'').trim());
}

/* ================= 問題URL ================= */
const URLS={ ori:"https://docs.google.com/spreadsheets/d/e/2PACX-1vSFuFjp8CnBMqfdRPKbQ_FPC6zWwgdQBVdTDsdWTHbBN92vXADxbVTmHdLm_C3Yn-Eeu5ZWm9WXRb0c/pub?output=csv",
ent:"https://docs.google.com/spreadsheets/d/e/2PACX-1vRjKfK1zTkytDnO1HiVRHa0N79VJncU_IXC3uv8Q2EBvBIm5mRPw82ie-widupSvvlR1vQdkVeeIIMM/pub?output=csv",
anime:"https://docs.google.com/spreadsheets/d/e/2PACX-1vQTBRf9k4zS7Ht5s7GKejqT2d-cyWbDHd19DwTPmAzoHe40d9nV1cVu-RH565sIq9GbYmEKkzhpBytp/pub?output=csv",
social:"https://docs.google.com/spreadsheets/d/e/2PACX-1vTXVYOqHu_0VRIkiVK0RQO-ZWPZ6pHGqIw5VxBWdOlg3-HbP3q26gM0fVxTndREhjqbaxFzcjeuoMcE/pub?output=csv",
life:"https://docs.google.com/spreadsheets/d/e/2PACX-1vSTr7JL0lBCMLRBFi-CraPlJxzp4xrGD8RSnc8MSuoV3ORISo0iCFWMmI_FCtDlgkxwPqmv_TwAvufn/pub?output=csv",
sport:"https://docs.google.com/spreadsheets/d/e/2PACX-1vSJYls3O8_98SKNWqx34c0V5HLIaXdxxA8v4E3c1iwrTFZBL1TSxzeem9AbKZKYfMkQEcu7bECcsgVo/pub?output=csv"
};

/* ================= 管理画面初期化 ================= */
async function initAdmin(){
  for(const [k,url] of Object.entries(URLS)){
    const res=await fetch(url+"&t="+Date.now());
    const txt=await res.text();
    const rows=txt.split('\n').slice(1);
    masterData[k]=rows.map(l=>{
      const p=parseCSVLine(l);
      return (p[0]&&p[1])?{q:p[0],a:p[1]}:null;
    }).filter(Boolean);
    masterData.all.push(...masterData[k]);
  }
  renderList();
}

/* ================= 検索修正 ================= */
function renderList(){
  const s=document.getElementById('search').value.toLowerCase();
  let list=masterData[activeGenre]||[];
  if(s){
    list=list.filter(i =>
      i.q.toLowerCase().includes(s) ||
      i.a.toLowerCase().includes(s)
    );
  }else{
    list=[...list].sort(()=>Math.random()-0.5).slice(0,30);
  }
  document.getElementById('quiz-list-area').innerHTML=
    list.map(i=>`<div onclick="applyQuiz('${i.q.replace(/'/g,"\\'")}','${i.a.replace(/'/g,"\\'")}')"
    style="padding:10px;border-bottom:1px solid #eee;${usedSet.has(i.q)?'opacity:.3':''}">
    <b>${i.a}</b><br><small>${i.q}</small></div>`).join('');
}

/* ================= 問題適用 ================= */
function applyQuiz(q,a){
  clearInterval(timer);
  revealed=[];
  currentQuiz={q,a};
  usedSet.add(q);
  history.push({q,a});
  db.ref().update({
    status:"waiting", winner:"",
    boardAnswers:null, correctList:null, wrongList:null,
    typing:null, finalReveal:false, isGameSet:false
  });
}

/* ================= 読上修正（二重防止） ================= */
function startQuiz(){
  clearInterval(timer);
  db.ref('status').set('active');
  const sp=parseInt(document.getElementById('readSpeed').value);
  timer=setInterval(()=>{
    if(revealed.length<currentQuiz.q.length){
      let i=0; while(revealed.includes(i)) i++;
      revealed.push(i); sync();
    }else clearInterval(timer);
  },sp);
}

/* ================= PUSH安定化 ================= */
function pushBtn(){
  const name=document.getElementById('p-name').value.trim();
  if(!name) return alert("名前を入力！");
  db.ref('winner').transaction(c => c || name, (_, committed)=>{
    if(committed) db.ref('status').set('pushed');
  });
}

/* ================= 全消去完全版 ================= */
function resetAll(){
  if(!confirm("全リセットしますか？")) return;
  history=[];
  usedSet.clear();
  db.ref().set({
    status:"idle",
    mode:"push",
    rankVisible:true,
    scores:null,
    waits:null,
    winner:"",
    boardAnswers:null,
    correctList:null,
    wrongList:null,
    typing:null,
    isGameSet:false
  });
}
</script>
</body>
</html>
